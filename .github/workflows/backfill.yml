on:
  workflow_dispatch:
    inputs:
      timerange:
        description: '[yyyymm] Target month to download/backfill'
        required: true
  repository_dispatch:
    type:
      - backfill
      - chain

permissions:
  contents: write
  repository-projects: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  timerange: ${{ github.event.client_payload.timerange || github.event.inputs.timerange }}

jobs:
  backfill:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { exchange: binanceus, stake: USDT, timeframes: '1m 3m 5m 15m 30m 1h 2h 4h 6h 8h 12h 1d' }
          - { exchange: bitcoincom, stake: USDT, timeframes: '1m 3m 5m 15m 30m 1h 4h 1d' }
          - { exchange: coinbase, stake: USDT, timeframes: '1m 5m 15m 30m 1h 2h 6h 1d' }
          - { exchange: kraken, stake: USD, timeframes: '1m 5m 15m 30m 1h 4h 1d', extra: '--dl-trades --erase' }
          - { exchange: kucoin, stake: USDT, timeframes: '1m 3m 5m 15m 30m 1h 2h 4h 6h 8h 12h 1d' }
          - { exchange: okx, stake: USDT, timeframes: '1m 3m 5m 15m 30m 1h 2h 4h 6h 12h 1d' }
    steps:
      - name: Git checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 1

      - name: Git checkout
        uses: actions/checkout@main
        continue-on-error: true
        with:
          fetch-depth: 1
          ref: "data/${{ matrix.exchange }}/${{ matrix.stake }}/${{ env.timerange }}"
          path: user_data/data/${{ matrix.exchange }}

      - name: Download
        shell: bash
        env:
          EXCHANGE: ${{ matrix.exchange }}
          STAKE: ${{ matrix.stake }}
        run: |
          echo "::group::(before)list-data --show-timerange"
          bash freqtrade.sh list-data --show-timerange --exchange ${{ matrix.exchange }}
          echo "::endgroup::"
          echo "::group::download-data"
          ENDRANGE=$(date +%Y%m -d '${{ env.timerange }}01 + 1 month')
          bash freqtrade.sh download-data --exchange ${{ matrix.exchange }} -p '.*/${{ matrix.stake }}' --timerange ${{ env.timerange }}01-${ENDRANGE}01 --timeframes ${{ matrix.timeframes }} ${{ matrix.extra || '' }}
          echo "::endgroup::"
          echo "::group::(after)list-data --show-timerange"
          bash freqtrade.sh list-data --show-timerange --exchange ${{ matrix.exchange }}
          echo "::endgroup::"

      - name: Push changes
        shell: bash
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          sudo chown -R $(id -u):$(id -g) user_data/data/${{ matrix.exchange }}
          cd user_data/data/${{ matrix.exchange }}
          if [[ $(git status --porcelain . | wc -l) -gt 0 ]]; then
            git add .
            git commit -m "ci: Autoupdate $(date -u +'%F %T')"
            git push -u origin "$(git branch --show-current):data/${{ matrix.exchange }}/${{ matrix.stake }}/${{ env.timerange }}"
          fi
  dispatch:
    runs-on: ubuntu-latest
    needs: [backfill]
    steps:
      - id: info
        shell: bash
        run: |
          timerange=$(date +%Y%m -d '${{ env.timerange }}01 - 1 month')
          if [[ "${timerange}" != 2022* ]]; then
            echo "timerange=${timerange}" | tee -a ${GITHUB_OUTPUT}
          fi
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@main
        if: steps.info.outputs.timerange != '' && (github.event.event_type == 'chain' || github.event_name == 'workflow_dispatch' )
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          event-type: chain
          client-payload: '{"timerange": "${{ steps.info.outputs.timerange }}"}'

